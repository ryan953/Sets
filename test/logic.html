<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
<title>Test: logic.js</title>
<link rel="stylesheet" href="../lib/qunit.css" type="text/css" media="screen" />
<script src="../lib/qunit.js"></script>
<script src="../lib/jquery-1.6.4.js"></script>
<script src="../lib/event.js"></script>

<script src="../js/logic.js"></script>

<script>
"use strict";
var Card = Sets.Card;
var Deck = Sets.Deck;
var Game = Sets.Game;

$(document).ready(function () {
	module('Event');
	asyncTest('Create and fire an event', function() {
		var evt = new Event(),
			obj = {
				test:function(e, data) {
					equal(eventData, data, 'event fired and arguments are ok');
					start();
				},
				name: 'hello'
			},
			name = 'sample-event',
			action = obj.test,
			binding = obj,
			eventData = {v1:'abc', v2:'123'};

		evt.addListener(obj, name, action/*, binding*/);
		evt.fireEvent({}, obj, name, eventData);
	});

	test('Can unbind an event', function() {
		var evt = new Event(),
		obj = { test:function(e, data) {} },
		name = 'sample-event',
		action = obj.test,
		binding = obj;

		evt.addListener(obj, name, action/*, binding*/);
		evt.removeListener(obj, name, action/*, binding*/);
		ok(true, 'event should be unbound');
	});

	module('Cards');
	test('Creating a card', function() {
		var c = new Card();
		ok(c, "new card created successfully");
	});

	test('Card.factory() builds a card', function() {
		var props = {
			count: 2,
			shape: 'Oval',
			fill: 'solid',
			color: 'blue'
		};
		var card = new Card(2, 'Oval', 'solid', 'blue');
		deepEqual(Card.factory(props), card, 'Factory can build cards correctly');

	});

	test('isEmpty works correctly', function () {
		ok(new Card().isEmpty(), "A card with no params IS empty");
		ok(new Card( 1, "Oval", "striped").isEmpty(), "A card with only 3 params IS empty");

		ok(!(new Card( 1, "Oval", "striped", "green").isEmpty()), "A card with all 4 params is NOT empty");
	});

	test('select/deselect/toggle', function() {
		var c = new Card();

		c.select();
		ok(c.isSelected, 'card gets selected');
		c.deselect();
		ok(!c.isSelected, 'card gets UNselected');
		c.toggleSelect();
		ok(c.isSelected, 'card gets toggled');
	});
	
	test('getClassAttr', function() {
		Card.classNameMap.attr_one = 'class-one';
		Card.classNameMap.attr_two = 'class-two';
		
		var c = new Card();
		equal('', c.getClassAttr(), 'should have no clasname');
		
		c.attr_one = true;
		equal('class-one', c.getClassAttr(), 'should now have a classname');
		
		c.attr_two = true;
		equal('class-one class-two', c.getClassAttr(), 'should have two classnames');
	});

	module('Decks');
	test('A Deck is created', function() {

		var deck = new Deck();
		equal(3*3*3*3, deck.size, 'the size of the deck is reported');
		equal(3*3*3*3, deck.cards.length, "All cards are here" );
		equal('regular', deck.mode, 'mode defaults to `regular`');

		deck = new Deck('regular');
		equal(3*3*3*3, deck.size, 'the size of the deck is reported');
		equal(3*3*3*3, deck.cards.length, 'all cards are here - regular mode');
		equal('regular', deck.mode, 'mode sets when passed');

		deck = new Deck('easy');
		equal(3*3*3, deck.size, 'the size of the deck is reported');
		equal(3*3*3, deck.cards.length, 'all cards are here - easy mode');
		equal('easy', deck.mode, 'mode sets when passed');
	});

	test('A card can be picked from a deck', function() {
		var deck = new Deck(),
			deckSize = (3*3*3*3),
			c = deck.pickCard(0);

		ok(c instanceof(Card), 'Picked the first card');
		equal( deckSize - 1, deck.cards.length, 'the picked card was removed from the deck');

		c = deck.pickRandomCard();
		ok(c instanceof(Card), 'Picked a random card');
		equal( deckSize - 2, deck.cards.length, 'the picked card was removed from the deck');
	});


	module('Game Game');
	test('isASet is detecting correctly', function() {
		var diff_color = [
			new Card( 1, "Oval", "striped", "green"),
			new Card( 1, "Oval", "striped", "red"),
			new Card( 1, "Oval", "striped", "blue")
		],
		diff_color_shape = [
			new Card( 1, "Diamond",	"striped", "green"),
			new Card( 1, "Oval", "striped", "red"),
			new Card( 1, "Squiggle", "striped", "blue")
		],
		diff_color_shape_count = [
			new Card( 1, "Diamond", "striped", "green"),
			new Card( 2, "Oval", "striped", "red"),
			new Card( 3, "Squiggle", "striped", "blue")
		];

		equal(true, Game.isASet(diff_color), 'Detected a set where card COLORS differ');
		equal(true, Game.isASet(diff_color_shape), 'Detected a set where card COLORS differ, and SHAPE ');
		equal(true, Game.isASet(diff_color_shape_count), 'Detected a set where card COLORS differ, and SHAPE, and COUNT');
	});

	test('isASet is failing correctly', function() {
		var diff_color = [
			new Card( 1, "Oval", "striped", "green"),
			new Card( 1, "Oval", "striped", "green"),
			new Card( 1, "Oval", "striped", "blue")
		],
		diff_color_shape = [
			new Card( 1, "Oval", "striped", "green"),
			new Card( 1, "Oval", "striped", "green"),
			new Card( 1, "Diamond", "striped", "blue")
		],
		four_cards = [new Card(), new Card(), new Card(), new Card()],
		two_cards = [new Card(), new Card()],
		one_card = [new Card()];

		equal(false, Game.isASet(diff_color), "Two colors are the same, one different");
		equal(false, Game.isASet(diff_color_shape), "Two colors are the same, one different + Two shapes same, one different");
		equal(false, Game.isASet(four_cards), "Four cards passed in");
		equal(false, Game.isASet(two_cards), "Only two cards passed in");
		equal(false, Game.isASet(one_card), "Only one card passed in");
	});

	function gameStartTest(mode) {
		asyncTest('Game Starts in ' + mode + ' mode', function() {
			expect(4); // the event gets fired twice cuz we call game.start() twice

			var game = new Game(),
			startHandler = function() {
				ok(this, '`start` event caught');
				start();
			};

			game.bind('start', startHandler);

			game.start(mode); //triggers an event with an assertion

			mode = (mode ? mode : 'easy');

			ok(game.board, 'game board is not empty');
			ok(!game.selected.length, 'no cards are selected when we start');
			equal(game.board.length, Game.modes[mode].rows, mode + ' mode has 4 rows (3 for easy)');

			game.unbind('start', startHandler);
		});
	}
	gameStartTest('regular');
	gameStartTest('easy');
	gameStartTest();

	test('selecting a card fires `select-card` & adds/removes it from the list', function() {
		stop(6);
		expect(12);

		var game = new Game().start(),
		expectedSelectedCounts = [1, 2, 3, 1, 2, 1],
		selectHandler = function(e, selected) {
			var expectedCount = expectedSelectedCounts.shift();
			equal(e.name, 'select-card', 'The correct event was fired');
			equal(selected.length, expectedCount, expectedCount + ' card(s) are selected');
			start();
		},
		deselectHandler = function(e, selected) {
			var expectedCount = expectedSelectedCounts.shift();
			equal(e.name, 'deselect-card', 'The correct event was fired');
			equal(selected.length, expectedCount, expectedCount + ' card(s) are selected');
			start();
		};

		game
			.bind('select-card', selectHandler)
			.bind('deselect-card', deselectHandler)

			.selectCard(game.getCard(0, 0))
			.selectCard(game.getCard(0, 1))
			.selectCard(game.getCard(0, 2))

			.selectCard(game.getCard(1, 0))
			.selectCard(game.getCard(1, 1))
			.selectCard(game.getCard(1, 0));
	});
	
	asyncTest('selecting a card and deselecting it fires `selection-cleared` event', function() {
		expect(1);
		
		var game = new Game().start(),
		card = game.getCard(0, 0),
		clearedHandler = function(e, selected) {
			equal(e.name, 'selection-cleared', 'The `selection-cleared` event was caught');
			start();
		};
		
		game.bind('selection-cleared', clearedHandler)
			.selectCard(card)
			.selectCard(card);
	});

	asyncTest('`found-set` is triggered after a set is selected', function() {
		expect(2);

		var game = new Game(),
		foundHandler = function(e, set) {
			ok(true, 'found a set');
			start();
		};

		game._init();
		game.deck.pickRandomCard = function(idx) {
			return this.pickCard(0);
		};
		game._loadBoard();

		game.bind('found-set', foundHandler)
			.selectCard(game.getCard(0, 0))
			.selectCard(game.getCard(0, 1))
			.selectCard(game.getCard(0, 2));

		strictEqual(game.selected.length, 0, 'After finding a set, not cards should be selected');
	});

	test('replaceSet() removed from the board and replaces the cards you pass in', function() {
		var game = new Game().start();

		var orig_cards = [ game.board[0][0] ];
		game.replaceSet(orig_cards);
		var new_cards = [ game.board[0][0] ];

		notDeepEqual(new_cards, orig_cards, 'the passed in cards have been matched and replaced');
	});

	test('listCardsOnBoard() gives back all cards in order', function() {
		var game = new Game();
		var cards = [
			new Card(),
			new Card(),
			new Card(),
			new Card()
		];
		game._addCardToBoard(cards[0], 0, 0);
		game._addCardToBoard(cards[1], 0, 1);
		game._addCardToBoard(cards[2], 1, 0);
		game._addCardToBoard(cards[3], 1, 1);

		deepEqual(game.listCardsOnBoard(), cards, 'have a list of all cards returned');
	});
});
</script>

</head>
<body>
	<div id="qunit"></div>
	<div id="qunit-fixture">test markup, will be hidden</div>
</body>
</html>
