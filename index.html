<!DOCTYPE html>
<html>
<head>
<title>Sets!</title>

<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />

<meta name="viewport" content="width=device-width; user-scalable=no; initial-scale=1.0; maximum-scale=1.0;">

<link rel="stylesheet" href="./style.css" type="text/css">

</head>
<body>
<script>
	"use strict";
	var _gaq = _gaq || [];
	_gaq.push(['_setAccount', 'UA-24049225-1']);
	_gaq.push(['_trackPageview']);

	(function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = 'https://ssl.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	})();
</script>

<div id="menu">
	<div class="left dropdown">
		<a href="#options" class="button"><span>Sets!</span></a>
		<div id="options">
			<a href="#" class="button open"><span>Sets!</span></a>
			<ul>
				<li><a href="#settings">Settings</a></li>
				<li><a href="#stats" class="needs-localstorage">Stats</a></li>
				<li><a href="#about">About</a></li>
			</ul>
		</div>
	</div>
	<div class="right">
		<a class="button game-reset"><span>Reset</span></a>
	</div>
	<p class="center scoreboard-display">
		<span data-scoreboard-display="score">Deck: <span id="score">0/0</span></span>
		<span data-scoreboard-display="percent" class="hide">Sets Found: <span id="percent">00%</span></span>
		<span data-x-scoreboard-display="time" class="hide">Time: <span id="time">0:00</span></span>
	</p>
</div>

<div class="lightbox" id="settings">
	<h2>Settings</h2>
	<div>
		<input type="checkbox" id="settings-easy-mode" value="easy" checked="checked" />
		<label for="settings-easy-mode">Quick Start</label>
	</div>
	<!--  -->
	<div>
		<input type="checkbox" id="settings-help-mode" value="on" checked="checked" />
		<label for="settings-help-mode">Show Helpful Hints</label>
	</div>
	
</div>

<div class="lightbox" id="stats">
	<h2>Stats</h2>
	<p>123</p>
</div>

<div class="lightbox" id="help">
	<h2>How to play Sets!</h2>
	<p>blah blah blah</p>
</div>

<div class="lightbox" id="about">
	<h2>About</h2>
	<p>This webapp was designed and built by <a href="//ryanalbrecht.ca">Ryan Albrecht</a>.</p>
	<p>It works really well on mobile devices and webkit based browsers like Chrome or Safari.
	Specifically, your browser should support the following for the complete experience:</p>
	<ul>
		<li><code>&lt;canvas&gt;</code></li>
		<li>CSS3
			<ul>
				<li>background gradients</li>
				<li><code>border-radius</code></li>
				<li><code>box-sizing</code></li>
				<li><code>-webkit-transform</code></li>
				<li><code>@media</code> queries</li>
				<li><code>@-webkit-keyframes</code> animations</li>
			</ul>
		</li>
		<li>JavaScript 1.6
			<ul>
				<li><code>Array.prototype.forEach()</code></li>
				<li><code>Array.prototype.reduce()</code></li>
			</ul>
		</li>
		<li>Web Workers</li>
	</ul>

	<p>See <a href="http://setgame.com/set/">http://setgame.com/set/</a> for more information.</p>
</div>

<div id="game-area"></div>
<div class="helping-message">thinking...</div>

<div class="popup" id="game-over">
	<h3>Game Over!</h3>
	<p>You won!</p>
	<a href="#" class="button game-reset"><span>Play Again</span></a>
</div>

<script src="./lib/jquery-1.6.4.js"></script>
<script src="./lib/NoClickDelay.js"></script>
<script src="./lib/event.js"></script>
<script src="./js/utils.js"></script>
<script src="./js/store.js"></script>
<script src="./js/assistant.js"></script>
<script src="./js/logic.js"></script>

<script>
"use strict";
function _(id) { return document.getElementById(id); }

$(document).ready(function() {
	_('game-area').ontouchmove = function(e){ e.preventDefault(); };
	new NoClickDelay(document.getElementsByTagName('body')[0]);

	function selectedMode() {
		return $('#settings-easy-mode').is(':checked') ? 'easy' : 'regular';
	}

	function helpMode() {
		return $('#settings-help-mode').is(':checked');
	}

	// Lightbox stuff -> jquery plugin?
	$('<a>')
		.addClass('right button lightbox-close')
		.text('Close')
		.prop('href', '#')
		.wrapInner('<span>')
		.appendTo( $('.lightbox') );
	$('.lightbox').wrapInner('<div>');
		

	var gameArea = _('game-area'),
		game = new Sets(), //game start is at the bottom, after we attach some events!
		ui = new SetsUI(gameArea),
		store = getStore();

	// settings -> needs ref to the store
	$('[id^=settings]').bind('change', function() {
		var self = $(this),
			key = self.prop('id'),
			value = self.val();
		if (self.filter('[type=checkbox]')) {
			value = self.prop('checked');
		}
		// console.debug('writing', key, value);
		store.put(key, value);
	}).each(function() {
		var self = $(this),
			key = self.prop('id'),
			value = store.get(key);
		// console.debug('read', key, value);
		if (value !== null) {
			if (self.filter('[type=checkbox]')) {
				self.prop('checked', value);
			} else {
				self.val(value);
			}
		}
	});



	// Game setup
	game
		.bind('end', function() {
			window.location = '#game-over';
		})
		.bind('start', function() {
			ui.renderGame(this);
		})
		.bind('select-card', function() { ui.updateSelected(this.board); })
		.bind('deselect-card', function() { ui.updateSelected(this.board); })
		.bind('selection-cleared', function(e, cards) { ui.showWrongSelection(this, cards); })
		.bind('found-set', function(e, cards) {
			ui.showFoundSet(this, cards);
		})
		.bind('score.change', function(e, data) {
			console.log('score.change', data);
			$('#score').html(data.found + '/' + data.deck);

			var percent = (data.deck != 0 ?  Math.round(data.found / data.deck * 1000)/10 : 0);
			$('#percent').html(percent + '%');
		});

	// Game DOM setup
	$('.game-reset').click(function() {
		ui.renderGame(
			game.start( selectedMode() )
		);
	});

	$('.scoreboard-display [data-scoreboard-display]').bind('click', function() {
		var elem = $(this);
		var visible = elem.hide().next('[data-scoreboard-display]').show();
		if (!visible.length) {
			visible = elem.siblings('[data-scoreboard-display]').first().show();
		}
		store.put('scoreboardDisplay', visible.data('scoreboardDisplay'));
	});
	// jquery plugin for '.scoreboard-display .time' is needed

	$(gameArea).delegate('td', 'click', function() {
		var self = $(this),
			row = self.parent().index(),
			col = self.index();
		game.selectCard(game.getCard(row, col));
	});

	// Assistant setup -> happens before game.start()
	// refs: game, assistant, settingsReader, ui
	var assistant = new Assistant(/* delay = */ 5500),
		clearAndRestartSearch = function(e) {
			if (helpMode()) {
				// console.debug('caught', e.name);
				assistant.stopSearch();
				assistant.startSearchForUnmatched(game.listCardsOnBoard());

				game.listCardsOnBoard().forEach(function(card) {
					if (assistant.unmatchedCards().indexOf(card) === -1) {
						card.notPossible = false;
					}
				});
				ui.updateSelected(game.board);
			}
		};

	assistant
		.bind('timer.start', function() {
			gameArea.className = 'helping';
		})
		.bind('timer.stop', function() {
			gameArea.className = '';
		})
		.bind('picked-not-possible', function(event, card) {
			game.getCard(card.row, card.col).notPossible = true;
			ui.updateSelected(game.board);
		});
	['start',
		'end',
		'select-card',
		'deselect-card',
		'selection-cleared',
		'found-set'].forEach(function(event) {
		game.bind(event, clearAndRestartSearch);
	});



	//after init
	game.start( selectedMode() );
});
</script>
</body>
</html>
